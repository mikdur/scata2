{% extends "scata2_base.html" %}
{% block title %}Dataset set: {{ object.name }} - {{ object.create_date|date:"Y-m-d" }}{% endblock %}

{% block scata2_content %}
<div class="flex flex-wrap gap-8">
{% if  object.description %}
<div class="p-4 w-96 bg-stone-100 rounded-lg shadow-md">
<h2 class="text-lg font-serif font-bold">Description</h2>
<div class="prose">
    {{ object.description }}
</div>
</div>
{% endif %}
<div class="p-4 w-96 bg-stone-100 rounded-lg shadow-md">
<h2 class="pb-2 pt-4 text-lg font-serif font-bold">General</h2>
<table class="table-auto min-w-full">
    <tr>
        <td class="font-semibold">Amplicon:</td>
        <td class="text-right">{{ object.amplicon.name }}</td>
    </tr>
    <tr>
        <td class="font-semibold">Total sequences:</td>
        <td class="text-right font-mono">{{ object.seq_total }}</td>
    </tr>
    <tr>
        <td class="font-semibold">Accepted sequences:</td>
        <td class="text-right font-mono">{{ object.seq_count }}</td>
    </tr>
    <tr>
        <td class="font-semibold">Number of tags/samples:</td>
        <td class="text-right font-mono">{{ object.tag_count }}</td>
    </tr>
    <tr>
        <td class="font-semibold">Discarded sequences:</td>
        <td class="text-right font-mono">{{ discarded }}</td>
    </tr>
    <tr>
        <td class="font-semibold">Reverse complemented:</td>
        <td class="text-right font-mono">{{ object.seq_rev }}</td>
    </tr>

    <tr>
        <td class="font-semibold">File 1:</td>
        <td class="text-right font-mono">{{ object.file1.name }}</td>
    </tr>
    <tr>
        <td class="font-semibold">File 2:</td>
        <td class="text-right font-mono">{{ object.file2.name }}</td>
    </tr>

    <tr>
        <td class="font-semibold">Process time:</td>
        <td class="text-right font-mono">
            {{object.process_time|floatformat:"-2"}}s 
        </td>
    </tr>
</table>
</div>
{% if errors %}
<div class="p-4 w-96 bg-stone-100 rounded-lg shadow-md">

<h2 class="pb-2 pt-4 text-lg font-serif font-bold">Errors</h2>
<table class="table-auto min-w-full">
    {% for error in errors %}
    <tr>
        <td class="font-semibold">{{ error.message }}:</td>
        <td class="text-right font-mono">{{ error.count }}</td>
    </tr>
    {% endfor %}
</table>
{% endif %}
</div>
<div class="p-4 w-96 bg-stone-100 rounded-lg shadow-md">
<h2 class="pb-2 pt-2 text-lg font-serif font-bold">Settings</h2>
<table class="table-auto min-w-full">
    <tr>
        <td class="font-semibold">Filter method:</td>
        <td class="text-right font-mono">{{ object.filter_method }}</td>
    </tr>
    <tr>
        <td class="font-semibold">Mininimum quality:</td>
        <td class="text-right">{{ object.min_qual }}</td>
    </tr>
    <tr>
        <td class="font-semibold">Mininimum mean quality:</td>
        <td class="text-right">{{ object.mean_qual }}</td>
    </tr>
    <tr>
        <td class="font-semibold">Overlap kmer size/hsp count/#shared</td>
        <td class="text-right">{{ object.kmer_size }}/{{ object.kmer_hsp_count }}/{{ object.kmer_shared }}</td>
    </tr> 
</table>
</div>
{% if tags %}
<div class="p-4 w-96 bg-stone-100 rounded-lg shadow-md">
<h2 class="pb-2 pt-2 text-lg font-serif font-bold">Downloads</h2>
<table class="table-auto min-w-full">
    <tr>
        <td class="font-semibold">Tag stats CSV:</td>
        <td class="text-right">
            <a class="underline" 
               href="{% url "dataset-tags-csv" object.id %}">Download</a>
        </td>
    </tr>
    <tr>
        <td class="font-semibold">Tag stats JSON:</td>
        <td class="text-right">
            <a class="underline" 
               href="{% url "dataset-tags" object.id %}">Download</a>
            </td>
    </tr>
</table>
</div>
{% endif %}
{% if tags %}
<div class="p-4 bg-stone-100 rounded-lg shadow-md w-11/12">
    <h2 class="pb-2 pt-2 text-lg font-serif font-bold">Sample size distribution</h2>
    <div id="samplesize_plot" class="min-w-full">
    </div>
</div>

<div  class="p-4 w-11/12 bg-stone-100 rounded-lg shadow-md">
    <h2 class="pb-2 pt-2 text-lg font-serif font-bold">Sample characteristics</h2>
    <div x-data="" class="flex flex-col p-2">
        <div class="flex ">
            <label class="px-2">X-axis:</label>
            <select x-on:input="set_axis1" class="px-2">
                <option value="pc1" selected>PC1</option>
                <option value="pc2">PC2</option>
                <option value="pc3">PC3</option>
                <option value="mean_gc">GC</option>
                <option value="count">Sequence count</option>
                <option value="mean_len">Mean length</option>
            </select>
        <div class="flex">
            <label class="px-2">Y-axis:</label>
            <select x-on:input="set_axis2" class="px-2">
                <option value="pc1">PC1</option>
                <option value="pc2" selected>PC2</option>
                <option value="pc3">PC3</option>
                <option value="mean_gc">GC</option>
                <option value="count">Sequence count</option>
                <option value="mean_len">Mean length</option>
            </select>
        </div>
        </div>
    </div>
    <div id="pca1" class="min-w-full">
    </div>
</div>
<div class="p-4 bg-stone-100 rounded-lg shadow-md w-11/12">
    <h2 class="pb-2 pt-2 text-lg font-serif font-bold">Tag Table</h2>
    <table id="tags" class="table-auto">
        <thead>
            <tr>
                <td>Tag name</td>
                <td>#Sequences</td>
                <td>#Reversed</td>
                <td>Min length</td>
                <td>Mean length</td>
                <td>Max length</td>
                <td>%GC</td>
            </tr>
        </thead>
        <tbody>
        {% for tag in tags %}
        <tr>
            <td>
                {{ tag.tag }}
            </td>
            <td>
                {{ tag.count }}
            </td>
            <td>
                {{ tag.reversed }}
            </td>
            <td>
                {{ tag.min_len }}
            </td>
            <td>
                {{ tag.mean_len|floatformat:"0" }}
            </td>
            <td>
                {{ tag.max_len }}
            </td>
            <td>
                {{ tag.mean_gc|floatformat:"-2" }}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
let table = new DataTable('#tags', {
    order: [[3, 'desc']]
});
</script>


<script type="module" >
    
    const data = await d3.json("./detail/tags.json");

    const plot = Plot.plot({
        width: 900,
        y: {
          grid: true,
          percent: false
        },
        x: {
            label: null,
            tick: null
        },
        marks: [
          Plot.ruleY([0]),
          Plot.barY(data.data, {x: "tag", y: "count", 
                                fill: "mean_gc",
                                tip: "x",
                                sort: {x: "y", reverse: true}}),
          Plot.axisX({ticks: []}),
          Plot.ruleX([0])
            
        ],
        color: {
            scheme: "viridis",
            type: "linear",
            domain: [0.4, 0.6]

        }
      });

    const div = document.querySelector("#samplesize_plot");
    div.append(plot);

    </script>
    <script type="module">
    const data = await d3.json("./detail/pca-tags.json");
    let axis1 = "pc1";
    function set_axis1(e){
        axis1 = e.srcElement.value
        draw_pca();
    }

    let axis2 = "pc2";
    function set_axis2(e){
        axis2 = e.srcElement.value
        draw_pca();
    }
    window.set_axis1 = set_axis1;
    window.set_axis2 = set_axis2;


    function draw_pca() {
    const plot_pca1 = Plot.plot({
        grid: true,
        inset: 10,
        x: {label: axis1 },
        y: {label: axis2 },
        marks: [
          Plot.dot(data.data, {x: axis1, y: axis2,
                               fill: "mean_gc",
                               channels: {Tag:"tag", Count:"count"},
                                tip: true})
        ],
        color: {
            scheme: "viridis",
            type: "linear",
            domain: [0.4, 0.6]

        }
      });


    const div_pca1 = document.querySelector("#pca1");

    d3.select(div_pca1).selectChild("svg").remove();
    div_pca1.append(plot_pca1);
    } ;
    draw_pca();
    </script>


{% endblock %}